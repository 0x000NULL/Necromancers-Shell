# Necromancer's Shell - Makefile
# C11 standard, ncurses-based terminal game

# Compiler and flags
CC := gcc
CFLAGS := -std=c11 -Wall -Wextra -Werror -pedantic
INCLUDES := -Isrc

# Platform detection and library configuration
UNAME_S := $(shell uname -s 2>/dev/null || echo Windows)

ifeq ($(UNAME_S),Darwin)
    # macOS: Use Homebrew ncurses
    PLATFORM := MACOS
    NCURSES_PREFIX := $(shell brew --prefix ncurses 2>/dev/null || echo "/usr/local/opt/ncurses")
    INCLUDES += -I$(NCURSES_PREFIX)/include
    LIBS := -L$(NCURSES_PREFIX)/lib -lncurses -lm
else ifeq ($(UNAME_S),Linux)
    # Linux: Use system ncurses
    PLATFORM := LINUX
    LIBS := -lncurses -lm
else
    # Windows: Use PDCurses
    PLATFORM := WINDOWS
    LIBS := -lpdcurses -lm
endif

# Directories
SRC_DIR := src
BUILD_DIR := build
TEST_DIR := tests

# Version management
VERSION_FILE := VERSION
VERSION_HEADER := $(SRC_DIR)/core/version_info.h

# Read version from file
VERSION := $(shell cat $(VERSION_FILE) 2>/dev/null || echo "0.0.0")
VERSION_PARTS := $(subst ., ,$(VERSION))
VERSION_MAJOR := $(word 1,$(VERSION_PARTS))
VERSION_MINOR := $(word 2,$(VERSION_PARTS))
VERSION_PATCH := $(word 3,$(VERSION_PARTS))

# Build metadata
BUILD_DATE := $(shell date +%Y-%m-%d)
GIT_HASH := $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# Source files (auto-detected)
CORE_SRC := $(wildcard $(SRC_DIR)/core/*.c)
TERM_SRC := $(wildcard $(SRC_DIR)/terminal/*.c)
UTIL_SRC := $(wildcard $(SRC_DIR)/utils/*.c)
CMD_SRC := $(wildcard $(SRC_DIR)/commands/*.c) $(wildcard $(SRC_DIR)/commands/commands/*.c)
GAME_SRC := $(wildcard $(SRC_DIR)/game/souls/*.c) $(wildcard $(SRC_DIR)/game/resources/*.c) $(wildcard $(SRC_DIR)/game/world/*.c) $(wildcard $(SRC_DIR)/game/minions/*.c) $(SRC_DIR)/game/game_state.c $(SRC_DIR)/game/game_globals.c
MAIN_SRC := $(SRC_DIR)/main.c

ALL_SRC := $(CORE_SRC) $(TERM_SRC) $(UTIL_SRC) $(CMD_SRC) $(GAME_SRC) $(MAIN_SRC)
ALL_OBJ := $(ALL_SRC:$(SRC_DIR)/%.c=$(BUILD_DIR)/%.o)

# Test files
TEST_SRC := $(wildcard $(TEST_DIR)/*.c)
TEST_BIN := $(patsubst $(TEST_DIR)/%.c,$(BUILD_DIR)/test_%,$(TEST_SRC))

# Targets
TARGET := $(BUILD_DIR)/necromancer_shell
TARGET_DEBUG := $(BUILD_DIR)/necromancer_shell_debug

# Default target
.DEFAULT_GOAL := release

# Build modes
.PHONY: all debug release clean test valgrind help version

all: debug release

debug: CFLAGS += -g -O0 -DDEBUG -fsanitize=address -fsanitize=undefined
debug: LDFLAGS += -fsanitize=address -fsanitize=undefined
debug: $(TARGET_DEBUG)

# Release build (portable, no -march=native for CI compatibility)
# Use -march=native only for local builds (not in CI)
release: CFLAGS += -O2 -DNDEBUG
ifndef CI
  release: CFLAGS += -march=native
endif
release: $(TARGET)

# Main targets
$(TARGET): $(ALL_OBJ)
	@mkdir -p $(@D)
	$(CC) $(LDFLAGS) $^ -o $@ $(LIBS)
	@echo "Built release: $(TARGET)"

$(TARGET_DEBUG): $(ALL_OBJ)
	@mkdir -p $(@D)
	$(CC) $(LDFLAGS) $^ -o $@ $(LIBS)
	@echo "Built debug: $(TARGET_DEBUG)"

# Generate version.h from VERSION file
$(VERSION_HEADER): $(VERSION_FILE)
	@echo "Generating $@..."
	@mkdir -p $(@D)
	@echo "/* Auto-generated by Makefile - DO NOT EDIT */" > $@
	@echo "#ifndef NECROMANCERS_VERSION_INFO_H" >> $@
	@echo "#define NECROMANCERS_VERSION_INFO_H" >> $@
	@echo "" >> $@
	@echo "#define VERSION_MAJOR $(VERSION_MAJOR)" >> $@
	@echo "#define VERSION_MINOR $(VERSION_MINOR)" >> $@
	@echo "#define VERSION_PATCH $(VERSION_PATCH)" >> $@
	@echo "#define VERSION_STRING \"$(VERSION)\"" >> $@
	@echo "#define VERSION_BUILD_DATE \"$(BUILD_DATE)\"" >> $@
	@echo "#define VERSION_GIT_HASH \"$(GIT_HASH)\"" >> $@
	@echo "" >> $@
	@echo "#endif /* NECROMANCERS_VERSION_INFO_H */" >> $@

# Object files (depend on version header)
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c $(VERSION_HEADER)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# Dependency tracking
-include $(ALL_OBJ:.o=.d)

$(BUILD_DIR)/%.d: $(SRC_DIR)/%.c
	@mkdir -p $(@D)
	@$(CC) $(CFLAGS) $(INCLUDES) -MM -MT $(BUILD_DIR)/$*.o $< -MF $@

# Tests
test: $(TEST_BIN)
	@echo "Running tests..."
	@for test in $(TEST_BIN); do \
		echo "Running $$test..."; \
		$$test || exit 1; \
	done
	@echo "All tests passed!"

$(BUILD_DIR)/test_%: $(TEST_DIR)/%.c $(filter-out $(BUILD_DIR)/main.o,$(ALL_OBJ))
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCLUDES) $^ -o $@ $(LIBS)

# Memory checking
valgrind: debug
	valgrind --leak-check=full \
	         --show-leak-kinds=all \
	         --track-origins=yes \
	         --verbose \
	         --log-file=valgrind-out.txt \
	         $(TARGET_DEBUG)
	@echo "Valgrind output written to valgrind-out.txt"

# Profiling
profile: CFLAGS += -pg
profile: $(TARGET)
	./$(TARGET)
	gprof $(TARGET) gmon.out > profile.txt
	@echo "Profile written to profile.txt"

# Static analysis
analyze:
	cppcheck --enable=all --inconclusive --std=c11 $(SRC_DIR)

# Formatting
format:
	find $(SRC_DIR) $(TEST_DIR) -name "*.c" -o -name "*.h" | xargs clang-format -i

# Clean
clean:
	rm -rf $(BUILD_DIR)
	rm -f $(VERSION_HEADER)
	rm -f valgrind-out.txt gmon.out profile.txt

# Version display
version:
	@echo "Necromancer's Shell v$(VERSION)"
	@echo "  Platform: $(PLATFORM)"
	@echo "  Major: $(VERSION_MAJOR)"
	@echo "  Minor: $(VERSION_MINOR)"
	@echo "  Patch: $(VERSION_PATCH)"
	@echo "  Build Date: $(BUILD_DATE)"
	@echo "  Git Hash: $(GIT_HASH)"

# Help
help:
	@echo "Necromancer's Shell - Build System"
	@echo ""
	@echo "Targets:"
	@echo "  make              - Build release version"
	@echo "  make debug        - Build debug version with sanitizers"
	@echo "  make release      - Build optimized release version"
	@echo "  make test         - Build and run all tests"
	@echo "  make valgrind     - Run with valgrind memory checker"
	@echo "  make profile      - Build with profiling, run, and generate profile"
	@echo "  make analyze      - Run static analysis (cppcheck)"
	@echo "  make format       - Format code with clang-format"
	@echo "  make clean        - Remove all build artifacts"
	@echo "  make version      - Display version information"
	@echo "  make help         - Show this help"

# Include dependency files
DEPS := $(ALL_OBJ:.o=.d)
-include $(DEPS)
